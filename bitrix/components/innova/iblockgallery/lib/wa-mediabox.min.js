/*
 * WA MediaBox
 *
 * @author WA Studio <www.webarts.name>
 * @author Jiri Hybek <jiri@hybek.cz>
 * @license MIT
 */

(function(){

	/*
	 * Preloader constructor
	 */
	var Preloader = function(){

		this.el = document.createElement("div");
		this.el.classList.add("wa-mediabox-preloader");

		this.wrap = document.createElement("div");
		this.wrap.classList.add("wa-mediabox-preloader-wrap");

		this.spinner = document.createElement("div");
		this.spinner.classList.add("wa-mediabox-preloader-spinner");

		this.patch = document.createElement("div");
		this.patch.classList.add("wa-mediabox-preloader-patch");

		this.clipperLeft = document.createElement("div");
		this.clipperLeft.classList.add("wa-mediabox-preloader-clipper");
		this.clipperLeft.classList.add("left");

		this.clipperRight = document.createElement("div");
		this.clipperRight.classList.add("wa-mediabox-preloader-clipper");
		this.clipperRight.classList.add("right");

		var circle = document.createElement("div");
		circle.classList.add("wa-mediabox-preloader-circle");

		this.patch.appendChild(circle);
		this.clipperLeft.appendChild(circle.cloneNode(true));
		this.clipperRight.appendChild(circle.cloneNode(true));

		this.spinner.appendChild(this.clipperLeft);
		this.spinner.appendChild(this.patch);
		this.spinner.appendChild(this.clipperRight);

		this.wrap.appendChild(this.spinner);
		this.el.appendChild(this.wrap);

	};

	Preloader.prototype.show = function(){

		this.el.classList.remove("hidden");
		this.el.style.display = '';

	};

	Preloader.prototype.hide = function(){

		var self = this;

		this.el.classList.add("hidden");

		setTimeout(function(){

			if(self.el.classList.contains("hidden"))
				self.el.style.display = 'none';

		}, 350);

	};

	/* 
     * Gallery constructor
     */
	var WAMediaBoxIIBG_Gallery = function(parent){

		this.parent = parent;
		this.mediaList = [];
		
		this.opened = false;

		this.loaded = false;
		this.current = null;

		this.containerWidth = null;
		this.containerHeight = null;

	};

	/*
	 * Media adders
	 */
	WAMediaBoxIIBG_Gallery.prototype.addImage = function(src, title, instLink){

		this.mediaList.push({
			type: "image",
			src: src,
			title: title,
			instLink: instLink
		});

		return this.mediaList.length - 1;

	};
	
	WAMediaBoxIIBG_Gallery.prototype.addVideo = function(src, title, instLink){

		this.mediaList.push({
			type: "video",
			src: src,
			title: title,
			instLink: instLink
		});

		return this.mediaList.length - 1;

	};

	WAMediaBoxIIBG_Gallery.prototype.addIframe = function(src, title, width, height){

		this.mediaList.push({
			type: "iframe",
			src: src,
			title: title,
			width: width,
			height: height
		});

		return this.mediaList.length - 1;

	};

	/*
	 * Open gallery
	 */
	WAMediaBoxIIBG_Gallery.prototype.open = function(index){

		if(this.opened) return;

		var self = this;

		this.current = -1;
		this.loaded = false;

		//Create overlay and content wrapper
		this.overlay = document.createElement("div");
		this.overlay.classList.add("wa-mediabox-overlay");

		this.frame = document.createElement("div");
		this.frame.classList.add("wa-mediabox-frame");

		this.container = document.createElement("div");
		this.container.classList.add("wa-mediabox-container");

		this.title = document.createElement("div");
		this.title.classList.add("wa-mediabox-title");

		this.loading = new Preloader();

		//Buttons
		this.closeBtn = document.createElement("button");
		this.closeBtn.classList.add("wa-mediabox-close");
		this.closeBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>';
		this.closeBtn.setAttribute("title", this.parent.lang.close);

		this.prevBtn = document.createElement("button");
		this.prevBtn.classList.add("wa-mediabox-prev");
		this.prevBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" /></svg>';
		this.prevBtn.setAttribute("title", this.parent.lang.prev);

		this.nextBtn = document.createElement("button");
		this.nextBtn.classList.add("wa-mediabox-next");
		this.nextBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>';
		this.nextBtn.setAttribute("title", this.parent.lang.next);

		//Put together
		this.frame.appendChild(this.container);
		this.frame.appendChild(this.title);
		this.frame.appendChild(this.loading.el);
		this.frame.appendChild(this.closeBtn);
		this.frame.appendChild(this.prevBtn);
		this.frame.appendChild(this.nextBtn);

		this.overlay.appendChild(this.frame);
		document.body.appendChild(this.overlay);

		//Bind events
		this.overlay.addEventListener("click", function(ev){

			ev.stopPropagation();
			self.close();

		});

		this.closeBtn.addEventListener("click", function(ev){

			ev.stopPropagation();
			self.close();

		});

		this.prevBtn.addEventListener("click", function(ev){

			ev.stopPropagation();
			self.prev();

		});

		this.nextBtn.addEventListener("click", function(ev){

			ev.stopPropagation();
			self.next();

		});

		
		this.container.addEventListener("click", function(ev){

			ev.stopPropagation();

		});

		//Resize
		this.resizeHandler = function(){

			self.resizeContainer();

		};

		this.keyDownHandler = function(ev){

			ev.preventDefault();
			ev.stopPropagation();

			if(ev.keyCode === 37)
				self.prev();
			else if(ev.keyCode === 39)
				self.next();
			else if(ev.keyCode === 27)
				self.close();

			return false;

		};

		window.addEventListener("resize", this.resizeHandler);
		document.body.addEventListener("keydown", this.keyDownHandler);

		//Open
		setTimeout(function(){

			self.overlay.classList.add("opened");

			self.loadMedia(index);

		}, 10);

		//Set opened
		this.opened = true;

	};

	/*
	 * Close gallery
	 */
	WAMediaBoxIIBG_Gallery.prototype.close = function(){

		if(!this.opened) return;

		var self = this;

		this.overlay.classList.remove("opened");

		window.removeEventListener("resize", this.resizeHandler);
		document.body.removeEventListener("keydown", this.keyDownHandler);

		setTimeout(function(){

			self.overlay.parentElement.removeChild(self.overlay);
			self.opened = false;

			self.nextBtn = null;
			self.prevBtn = null;
			self.closeBtn = null;
			self.loading = null;
			self.container = null;
			self.frame = null;
			self.overlay = null;

			self.current = null;
			self.containerWidth = null;
			self.containerHeight = null;

		}, 450);

	};

	/*
	 * Resize container
	 */
	WAMediaBoxIIBG_Gallery.prototype.resizeContainer = function(){

		if(!this.opened) return;

		//Defaults
		if(!this.containerWidth)
			this.containerWidth = Math.round(this.overlay.offsetWidth * 0.7);

		if(!this.containerHeight)
			this.containerHeight = Math.round(this.overlay.offsetWidth * 0.7);

		var widthLimit = 160;

		if(this.overlay.offsetWidth < 480)
			widthLimit = 70;

		var maxWidth = Math.min(this.overlay.offsetWidth * 0.9, this.overlay.offsetWidth - widthLimit);
		var maxHeight = Math.min(this.overlay.offsetHeight * 0.9, this.overlay.offsetHeight - 64);

		var targetWidth = this.containerWidth;
		var targetHeight = this.containerHeight;

		//Resize if neccesary
		var ratio = targetWidth / targetHeight;

		if(targetWidth > maxWidth){
			targetWidth = Math.round(maxWidth);
			targetHeight = targetWidth / ratio;
		}

		if(targetHeight > maxHeight){
			targetHeight = Math.round(maxHeight);
			targetWidth = targetHeight * ratio;
		}

		//Set styles
		this.frame.style.width = targetWidth + "px";
		this.frame.style.height = targetHeight + "px";

		this.frame.style.marginLeft = -Math.round(targetWidth / 2) + "px";
		this.frame.style.marginTop = -Math.round(targetHeight / 2) + "px";

	};

	/*
	 * Set media into container
	 */
	WAMediaBoxIIBG_Gallery.prototype.setMedia = function(type, src, title, width, height){

		if(!this.opened) return;

		var self = this;
		this.loaded = false;

		this.frame.classList.remove("can-open-in-new");
		self.frame.classList.remove("has-title");

		//Reset content
		this.container.innerHTML = '';

		//Create proper element
		var mediaEl = null;

		if(type == "image"){

			//Resize
			if(width) this.containerWidth = width;
			if(height) this.containerHeight = height;
			this.resizeContainer();

			mediaEl = document.createElement("img");

			mediaEl.addEventListener("load", function(){

				self.containerWidth = mediaEl.width;
				self.containerHeight = mediaEl.height;

				self.resizeContainer();
				self.frame.classList.add("can-open-in-new");

				//Add to DOM
				self.container.appendChild(mediaEl);

			});

			mediaEl.src = src;

		} else if(type == "video"){

			//Resize
			if(width) this.containerWidth = width;
			if(height) this.containerHeight = height;
			this.resizeContainer();

			mediaEl = document.createElement("video");
			
			mediaEl.setAttribute("type", "video/mp4");
			
			mediaEl.setAttribute("id", "WAMediaBoxIIBGVideo");
			
			//mediaEl.setAttribute("preload", "none");
			
			mediaEl.setAttribute("loop", "true");

			mediaEl.addEventListener("loadeddata", function(){

				self.containerWidth = 640;
				self.containerHeight = 640;

				self.resizeContainer();
				self.frame.classList.add("can-open-in-new");
				
				
				var videoBtn = document.createElement("div");
			
				videoBtn.setAttribute("class", "wa-mediabox-video-btn");
				
				videoBtn.setAttribute("onclick", "WAMediaBoxIIBGPlayPause()");
			
				videoBtn.innerHTML = '<svg class="wa-mediabox-video-btn-play" id="wa-mediabox-video-btn-play" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 232.153 232.153" style="enable-background:new 0 0 232.153 232.153;" xml:space="preserve"><g><path style="fill-rule:evenodd;clip-rule:evenodd;" d="M203.791,99.628L49.307,2.294c-4.567-2.719-10.238-2.266-14.521-2.266   c-17.132,0-17.056,13.227-17.056,16.578v198.94c0,2.833-0.075,16.579,17.056,16.579c4.283,0,9.955,0.451,14.521-2.267   l154.483-97.333c12.68-7.545,10.489-16.449,10.489-16.449S216.471,107.172,203.791,99.628z" fill="#FFFFFF"/></g></svg><svg class="wa-mediabox-video-btn-pause" id="wa-mediabox-video-btn-pause" xmlns="http://www.w3.org/2000/svg" viewBox="-45 0 327 327"><path d="m158 0h71c4.417969 0 8 3.582031 8 8v311c0 4.417969-3.582031 8-8 8h-71c-4.417969 0-8-3.582031-8-8v-311c0-4.417969 3.582031-8 8-8zm0 0" fill="#FFFFFF"/><path d="m8 0h71c4.417969 0 8 3.582031 8 8v311c0 4.417969-3.582031 8-8 8h-71c-4.417969 0-8-3.582031-8-8v-311c0-4.417969 3.582031-8 8-8zm0 0" fill="#FFFFFF"/></svg>';
				
				self.container.innerHTML = mediaEl.outerHTML + videoBtn.outerHTML;

				//Add to DOM
				//self.container.appendChild(mediaEl);

			});

			mediaEl.src = src;

		} else {

			//Resize
			if(width) this.containerWidth = width;
			if(height) this.containerHeight = height + ( title ? 52 : 0 );
			this.resizeContainer();

			mediaEl = document.createElement("iframe");
			mediaEl.src = src;
			mediaEl.setAttribute("width", parseInt(this.frame.style.width));
			mediaEl.setAttribute("height", parseInt(this.frame.style.height) - ( title ? 52 : 0 ));
			mediaEl.setAttribute("frameborder", "0");
			mediaEl.setAttribute("allowfullscreen", "allowfullscreen");

			//Add to DOM
			this.container.appendChild(mediaEl);

		}

		
		if(type == "video") {
			//Wait for load
			mediaEl.addEventListener("loadeddata", function(){

				setTimeout(function(){
					
					//Set title
					if(title){
						self.title.innerHTML = title;
						self.frame.classList.add("has-title");
					}

					//Show
					self.frame.classList.add("loaded");
					self.loading.hide();
					self.loaded = true;

				}, 550);

			});
		} else {
			//Wait for load
			mediaEl.addEventListener("load", function(){

				setTimeout(function(){
					
					//Set title
					if(title){
						self.title.innerHTML = title;
						self.frame.classList.add("has-title");
					}

					//Show
					self.frame.classList.add("loaded");
					self.loading.hide();
					self.loaded = true;

				}, 550);

			});
		}

	};

	/*
	 * Load media at index
	 */
	WAMediaBoxIIBG_Gallery.prototype.loadMedia = function(index){

		if(!this.opened) return;
		if(index == this.current) return;

		var self = this;

		if(!this.mediaList[index]) throw new Error("Undefined media");

		var load = function(){

			self.setMedia( self.mediaList[index].type, self.mediaList[index].src, self.mediaList[index].title, self.mediaList[index].width, self.mediaList[index].height );

		};

		if(this.loaded){

			this.frame.classList.remove("loaded");
			this.loading.show();
			setTimeout(load, 350);

		} else {

			load();

		}

		if(index > 0)
			this.frame.classList.add("has-prev");
		else
			this.frame.classList.remove("has-prev");

		if(index < this.mediaList.length - 1)
			this.frame.classList.add("has-next");
		else
			this.frame.classList.remove("has-next");

		this.current = index;

	};

	/*
	 * Switch to previous media
	 */
	WAMediaBoxIIBG_Gallery.prototype.prev = function(){

		if(!this.opened) return;

		var index = Math.max(0, this.current - 1);
		this.loadMedia(index);

	};

	/*
	 * Switch to next media
	 */
	WAMediaBoxIIBG_Gallery.prototype.next = function(){

		if(!this.opened) return;

		var index = Math.min(this.mediaList.length - 1, this.current + 1);
		this.loadMedia(index);

	};

	WAMediaBoxIIBG_Gallery.prototype.openSource = function(){

		if(!this.opened) return;

		window.open( this.mediaList[this.current].instLink );

	};

	/*
	 * ImageBox constructor
	 */
	var WAMediaBoxIIBG = function(){

		this.lang = {
			prev: "Previous",
			next: "Next",
			close: "Close",
			openInNew: "Open in new window"
		};

		this.galleries = {};

	};

	WAMediaBoxIIBG.prototype.openGallery = function(gallery, index){

		if(!this.galleries[gallery]) throw new Error("Gallery not found");

		this.galleries[gallery].open(index);

	};

	/*
	 * Media adders
	 */
	WAMediaBoxIIBG.prototype.addImage = function(gallery, src, title, instLink){

		if(!this.galleries[gallery])
			this.galleries[gallery] = new WAMediaBoxIIBG_Gallery(this);

		return this.galleries[gallery].addImage(src, title, instLink);

	};
	
	WAMediaBoxIIBG.prototype.addVideo = function(gallery, src, title, instLink){

		if(!this.galleries[gallery])
			this.galleries[gallery] = new WAMediaBoxIIBG_Gallery(this);

		return this.galleries[gallery].addVideo(src, title, instLink);

	};

	WAMediaBoxIIBG.prototype.addIframe = function(gallery, src, title, width, height){

		if(!this.galleries[gallery])
			this.galleries[gallery] = new WAMediaBoxIIBG_Gallery(this);

		return this.galleries[gallery].addIframe(src, title, width, height);

	};

	/*
	 * Bind single elements
	 */
	WAMediaBoxIIBG.prototype.bind = function(el){

		if(el._waMediaBoxBound) return;

		el._waMediaBoxBound = true;

		var self = this;

		var gallery = el.getAttribute("data-mediabox") || "_";
		var src = String(el.getAttribute("href") || el.getAttribute("data-src"));
		var instLink = el.getAttribute("data-iblockgallery");
		var title = el.getAttribute("data-title");
		var isIframe = ( el.hasAttribute("data-iframe") || src.indexOf("youtube") >= 0 ? true : false );
		var isVideo = ( el.hasAttribute("data-video") ? true : false );
		var width = ( el.hasAttribute("data-width") ? parseInt(el.getAttribute("data-width")) : null );
		var height = ( el.hasAttribute("data-height") ? parseInt(el.getAttribute("data-height")) : null );

		var index = null;

		//Add to gallery
		if(isIframe)
			index = this.addIframe(gallery, src, title, width, height);
		else if(isVideo)
			index = this.addVideo(gallery, src, title, instLink);
		else
			index = this.addImage(gallery, src, title, instLink);
		
		//Bind open event
		el.addEventListener("click", function(ev){

			ev.preventDefault();
			ev.stopPropagation();

			self.openGallery(gallery, index);

			return false;

		});

	};

	/*
	 * Bind all elements in given parent node
	 */
	WAMediaBoxIIBG.prototype.bindAll = function(parentEl){

		var elements = parentEl.querySelectorAll("a[data-mediabox]");

		for(var i = 0; i < elements.length; i++)
			this.bind(elements.item(i));

	};

	//Assign to window
	window.WAMediaBoxIIBG = new WAMediaBoxIIBG();

	//Bind lightbox elements
	window.addEventListener("load", function(){
		
		window.WAMediaBoxIIBG.bindAll(document.body);

	});

})();

function WAMediaBoxIIBGPlayPause() { 
	var WAMediaBoxIIBGVideo = document.getElementById("WAMediaBoxIIBGVideo"); 
    if (WAMediaBoxIIBGVideo.paused) {
		document.getElementById("wa-mediabox-video-btn-play").style.display = 'none';
		document.getElementById("wa-mediabox-video-btn-pause").style.display = 'block';
        WAMediaBoxIIBGVideo.play(); 
    } else {
		document.getElementById("wa-mediabox-video-btn-pause").style.display = 'none';
		document.getElementById("wa-mediabox-video-btn-play").style.display = 'block';
        WAMediaBoxIIBGVideo.pause(); 
	}
} 